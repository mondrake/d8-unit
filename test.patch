diff --git a/core/lib/Drupal/Component/Diff/Diff.php b/core/lib/Drupal/Component/Diff/Diff.php
index 289bab5f0e..e976082767 100644
--- a/core/lib/Drupal/Component/Diff/Diff.php
+++ b/core/lib/Drupal/Component/Diff/Diff.php
@@ -3,6 +3,13 @@
 namespace Drupal\Component\Diff;
 
 use Drupal\Component\Diff\Engine\DiffEngine;
+use Drupal\Component\Diff\Engine\DiffOp;
+use Drupal\Component\Diff\Engine\DiffOpAdd;
+use Drupal\Component\Diff\Engine\DiffOpChange;
+use Drupal\Component\Diff\Engine\DiffOpCopy;
+use Drupal\Component\Diff\Engine\DiffOpDelete;
+use SebastianBergmann\Diff\Differ;
+use SebastianBergmann\Diff\Output\UnifiedDiffOutputBuilder;
 
 /**
  * Class representing a 'diff' between two sequences of strings.
@@ -16,6 +23,8 @@
  */
 class Diff {
 
+  private const CHANGED = 999;
+
   /**
    * The list of differences as an array of diff operations.
    *
@@ -34,11 +43,80 @@ class Diff {
    *   An array of strings.
    */
   public function __construct($from_lines, $to_lines) {
-    $eng = new DiffEngine();
-    $this->edits = $eng->diff($from_lines, $to_lines);
+    $differ = new Differ(new UnifiedDiffOutputBuilder());
+    $this->edits = $this->toDiffOps($differ->diffToArray($from_lines, $to_lines));
     //$this->_check($from_lines, $to_lines);
   }
 
+  private function toDiffOps(array $diffArray): array {
+    $ops = [];
+    $hunkMode = NULL;
+    $hunkSource = [];
+    $hunkTarget = [];
+
+    for ($i = 0; $i < count($diffArray); $i++) {
+
+      if (($diffArray[$i][1] === Differ::REMOVED || $diffArray[$i][1] === Differ::ADDED) && isset($diffArray[$i + 1])) {
+        if ($diffArray[$i][1] === Differ::REMOVED && $diffArray[$i + 1][1] === Differ::ADDED) {
+          $mode = self::CHANGED;
+        }
+        elseif ($diffArray[$i][1] === Differ::ADDED && $diffArray[$i + 1][1] === Differ::REMOVED) {
+          $mode = self::CHANGED;
+        }
+        else {
+          $mode = $diffArray[$i][1];
+        }
+      }
+      else {
+        $mode = $diffArray[$i][1];
+      }
+
+      if ($hunkMode === NULL) {
+        $hunkMode = $mode;
+      }
+      elseif ($hunkMode !== $mode) {
+        $ops[] = $this->hunkOp($hunkMode, $hunkSource, $hunkTarget);
+        $hunkMode = $mode;
+        $hunkSource = [];
+        $hunkTarget = [];
+      }
+
+      $hunkSource[] = $diffArray[$i][0];
+      if ($hunkMode === self::CHANGED) {
+        $hunkTarget[] = $diffArray[$i + 1][0];
+        $i++;
+      }
+    }
+
+    if ($hunkMode !== NULL) {
+      $ops[] = $this->hunkOp($hunkMode, $hunkSource, $hunkTarget);
+    }
+
+    return $ops;
+  }
+
+  private function hunkOp(int $mode, array $source, array $target): DiffOp {
+    switch ($mode) {
+      case Differ::OLD:
+        $op = new DiffOpCopy($source);
+        break;
+
+      case self::CHANGED:
+        $op = new DiffOpChange($source, $target);
+        break;
+
+      case Differ::ADDED:
+        $op = new DiffOpAdd($source);
+        break;
+
+      case Differ::REMOVED:
+        $op = new DiffOpDelete($source);
+        break;
+
+    }
+    return $op;
+  }
+
   /**
    * Compute reversed Diff.
    *
@@ -50,6 +128,7 @@ public function __construct($from_lines, $to_lines) {
    *   A Diff object representing the inverse of the original diff.
    */
   public function reverse() {
+    @trigger_error(__METHOD__ . '() is deprecated in drupal:10.0.0 and is removed from drupal:11.0.0. There is no replacement. See https://www.drupal.org/node/7654321', E_USER_DEPRECATED);
     $rev = $this;
     $rev->edits = [];
     foreach ($this->edits as $edit) {
@@ -64,6 +143,7 @@ public function reverse() {
    * @return bool True iff two sequences were identical.
    */
   public function isEmpty() {
+    @trigger_error(__METHOD__ . '() is deprecated in drupal:10.0.0 and is removed from drupal:11.0.0. There is no replacement. See https://www.drupal.org/node/7654321', E_USER_DEPRECATED);
     foreach ($this->edits as $edit) {
       if ($edit->type != 'copy') {
         return FALSE;
@@ -80,6 +160,7 @@ public function isEmpty() {
    * @return int The length of the LCS.
    */
   public function lcs() {
+    @trigger_error(__METHOD__ . '() is deprecated in drupal:10.0.0 and is removed from drupal:11.0.0. There is no replacement. See https://www.drupal.org/node/7654321', E_USER_DEPRECATED);
     $lcs = 0;
     foreach ($this->edits as $edit) {
       if ($edit->type == 'copy') {
@@ -98,6 +179,7 @@ public function lcs() {
    * @return array The original sequence of strings.
    */
   public function orig() {
+    @trigger_error(__METHOD__ . '() is deprecated in drupal:10.0.0 and is removed from drupal:11.0.0. There is no replacement. See https://www.drupal.org/node/7654321', E_USER_DEPRECATED);
     $lines = [];
 
     foreach ($this->edits as $edit) {
@@ -117,6 +199,7 @@ public function orig() {
    * @return array The sequence of strings.
    */
   public function closing() {
+    @trigger_error(__METHOD__ . '() is deprecated in drupal:10.0.0 and is removed from drupal:11.0.0. There is no replacement. See https://www.drupal.org/node/7654321', E_USER_DEPRECATED);
     $lines = [];
 
     foreach ($this->edits as $edit) {
@@ -133,6 +216,7 @@ public function closing() {
    * This is here only for debugging purposes.
    */
   public function check($from_lines, $to_lines) {
+    @trigger_error(__METHOD__ . '() is deprecated in drupal:10.0.0 and is removed from drupal:11.0.0. There is no replacement. See https://www.drupal.org/node/7654321', E_USER_DEPRECATED);
     if (serialize($from_lines) != serialize($this->orig())) {
       trigger_error("Reconstructed original doesn't match", E_USER_ERROR);
     }
diff --git a/core/lib/Drupal/Component/Diff/Engine/DiffEngine.php b/core/lib/Drupal/Component/Diff/Engine/DiffEngine.php
index f8ec05fbbb..6aba157acb 100644
--- a/core/lib/Drupal/Component/Diff/Engine/DiffEngine.php
+++ b/core/lib/Drupal/Component/Diff/Engine/DiffEngine.php
@@ -2,6 +2,8 @@
 
 namespace Drupal\Component\Diff\Engine;
 
+@trigger_error('\Drupal\Component\Diff\Engine\DiffEngine is deprecated in drupal:10.0.0 and is removed from drupal:11.0.0. Use SebastianBergmann/diff instead. See https://www.drupal.org/node/7654321', E_USER_DEPRECATED);
+
 /**
  * Class used internally by Diff to actually compute the diffs.
  *
diff --git a/core/lib/Drupal/Component/Diff/Engine/DiffOp.php b/core/lib/Drupal/Component/Diff/Engine/DiffOp.php
index 29d749dc7c..a777ee9f0f 100644
--- a/core/lib/Drupal/Component/Diff/Engine/DiffOp.php
+++ b/core/lib/Drupal/Component/Diff/Engine/DiffOp.php
@@ -13,14 +13,17 @@ class DiffOp {
   public $closing;
 
   public function reverse() {
+    @trigger_error(__METHOD__ . '() is deprecated in drupal:10.0.0 and is removed from drupal:11.0.0. There is no replacement. See https://www.drupal.org/node/7654321', E_USER_DEPRECATED);
     trigger_error('pure virtual', E_USER_ERROR);
   }
 
   public function norig() {
+    @trigger_error(__METHOD__ . '() is deprecated in drupal:10.0.0 and is removed from drupal:11.0.0. There is no replacement. See https://www.drupal.org/node/7654321', E_USER_DEPRECATED);
     return $this->orig ? sizeof($this->orig) : 0;
   }
 
   public function nclosing() {
+    @trigger_error(__METHOD__ . '() is deprecated in drupal:10.0.0 and is removed from drupal:11.0.0. There is no replacement. See https://www.drupal.org/node/7654321', E_USER_DEPRECATED);
     return $this->closing ? sizeof($this->closing) : 0;
   }
 
diff --git a/core/lib/Drupal/Component/Diff/Engine/DiffOpAdd.php b/core/lib/Drupal/Component/Diff/Engine/DiffOpAdd.php
index 14429c251d..506821bb4c 100644
--- a/core/lib/Drupal/Component/Diff/Engine/DiffOpAdd.php
+++ b/core/lib/Drupal/Component/Diff/Engine/DiffOpAdd.php
@@ -16,6 +16,7 @@ public function __construct($lines) {
   }
 
   public function reverse() {
+    @trigger_error(__METHOD__ . '() is deprecated in drupal:10.0.0 and is removed from drupal:11.0.0. There is no replacement. See https://www.drupal.org/node/7654321', E_USER_DEPRECATED);
     return new DiffOpDelete($this->closing);
   }
 
diff --git a/core/lib/Drupal/Component/Diff/Engine/DiffOpChange.php b/core/lib/Drupal/Component/Diff/Engine/DiffOpChange.php
index 4abd6acc01..99e27e4ca4 100644
--- a/core/lib/Drupal/Component/Diff/Engine/DiffOpChange.php
+++ b/core/lib/Drupal/Component/Diff/Engine/DiffOpChange.php
@@ -16,6 +16,7 @@ public function __construct($orig, $closing) {
   }
 
   public function reverse() {
+    @trigger_error(__METHOD__ . '() is deprecated in drupal:10.0.0 and is removed from drupal:11.0.0. There is no replacement. See https://www.drupal.org/node/7654321', E_USER_DEPRECATED);
     return new DiffOpChange($this->closing, $this->orig);
   }
 
diff --git a/core/lib/Drupal/Component/Diff/Engine/DiffOpCopy.php b/core/lib/Drupal/Component/Diff/Engine/DiffOpCopy.php
index 4128d57329..8498722e30 100644
--- a/core/lib/Drupal/Component/Diff/Engine/DiffOpCopy.php
+++ b/core/lib/Drupal/Component/Diff/Engine/DiffOpCopy.php
@@ -19,6 +19,7 @@ public function __construct($orig, $closing = FALSE) {
   }
 
   public function reverse() {
+    @trigger_error(__METHOD__ . '() is deprecated in drupal:10.0.0 and is removed from drupal:11.0.0. There is no replacement. See https://www.drupal.org/node/7654321', E_USER_DEPRECATED);
     return new DiffOpCopy($this->closing, $this->orig);
   }
 
diff --git a/core/lib/Drupal/Component/Diff/Engine/DiffOpDelete.php b/core/lib/Drupal/Component/Diff/Engine/DiffOpDelete.php
index e402d66b61..10c6d9a1cc 100644
--- a/core/lib/Drupal/Component/Diff/Engine/DiffOpDelete.php
+++ b/core/lib/Drupal/Component/Diff/Engine/DiffOpDelete.php
@@ -16,6 +16,7 @@ public function __construct($lines) {
   }
 
   public function reverse() {
+    @trigger_error(__METHOD__ . '() is deprecated in drupal:10.0.0 and is removed from drupal:11.0.0. There is no replacement. See https://www.drupal.org/node/7654321', E_USER_DEPRECATED);
     return new DiffOpAdd($this->orig);
   }
 
